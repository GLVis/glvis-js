<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.0/async.min.js"></script>
    <script src="../src/glvis.js"></script>
    <script src="../src/index.js"></script>
    <script src="./keys.js"></script>
    <script src="./example_stream.js"></script>
    <link rel="stylesheet" href="style.css" />

    <link
      rel="icon"
      type="image/png"
      href="https://glvis.org/img/favicon.ico"
    />
  </head>

  <body>
    <!--https://www.w3schools.com/howto/howto_js_sidenav.asp-->
    <div id="setup-side-nav" class="sidenav">
      <a
        href="javascript:void(0)"
        class="closebtn"
        onclick="closeNav('setup-side-nav')"
        >&times;</a
      >

      <div align="center" class="full-width">
        <h3 align="center">Load visualization file</h3>
        <input
          type="file"
          id="load-file"
          onchange="glvis.loadStream(event, glv)"
          hidden
        />
        <label for="load-file" class="menu-button">Load File</label>
      </div>

      <div align="center" class="full-width">
        <h3 align="center">Connect to Server</h3>
        <p align="center">
          Display streaming content from MFEM. This requires m2w.py as an
          intermediary.
        </p>

        <div>
          <input type="text" id="host-text" value="localhost" />
        </div>

        <div>
          <input type="text" id="port-text" value="8080" />
        </div>

        <div>
          <label
            class="menu-button"
            type="button"
            id="conn-btn"
            onclick="connect()"
            >Connect</label
          >
        </div>
      </div>

      <!-- delay slider-->
      <!---
      <div class="full-width">
        <h4 align="center">Stream update delay</h4>
        <input type="range" min="50" max="1000" value="100" step="50" class="slider" id="delay-range">
        <div align="center" id="delay-value"></div>
      </div>
      -->
    </div>

    <div id="help-side-nav" class="sidenav">
      <a
        href="javascript:void(0)"
        class="closebtn"
        onclick="closeNav('help-side-nav')"
        >&times;</a
      >

      <div
        style="
          white-space: pre;
          display: inline-block;
          width: 40ch;
          overflow: auto;
          font-family: monospace;
        "
        id="keys-div"
      ></div>
    </div>

    <div id="ctrl-side-nav" class="sidenav">
      <a
        href="javascript:void(0)"
        class="closebtn"
        onclick="closeNav('ctrl-side-nav')"
        >&times;</a
      >
      <p></p>

      <div align="center">
        <!--&#x21DA-->
        <button type="button" onclick="glv.sendKey('p')">(left)</button>
        switch color palette
        <!--&#x21DB-->
        <button type="button" onclick="glv.sendKey('P')">(right)</button>
      </div>

      <p></p>
      <div align="center">
        <button type="button" onclick="glv.sendKey('r')">Reset 3D View</button>
      </div>

      <p></p>
      <div align="center">
        Light:
        <input
          type="radio"
          id="off"
          name="light"
          oninput="glv.sendKey('l')"
        /><label for="off">Off</label>
        <input
          type="radio"
          id="on"
          name="light"
          checked="checked"
          oninput="glv.sendKey('l')"
        /><label for="on">On</label>
      </div>

      <p></p>
      <div align="center">
        Colorbar:
        <input
          type="radio"
          id="off"
          name="colorbar"
          checked="checked"
          oninput="glv.sendKey('c')"
        /><label for="off">Off</label>
        <input
          type="radio"
          id="on"
          name="colorbar"
          oninput="glv.sendKey('c')"
        /><label for="on">On</label>
      </div>

      <p></p>
      <div align="center">
        Perspective:
        <input
          type="radio"
          id="off"
          name="perspective"
          oninput="glv.sendKey('j')"
        /><label for="off">Off</label>
        <input
          type="radio"
          id="on"
          name="perspective"
          checked="checked"
          oninput="glv.sendKey('j')"
        /><label for="on">On</label>
      </div>

      <p></p>
      <div align="center">
        Axis:
        <input
          type="radio"
          id="off"
          name="axis"
          checked="checked"
          oninput="glv.sendKey('a')"
        /><label for="off">Off</label>
        <input
          type="radio"
          id="on"
          name="axis"
          oninput="glv.sendKey('a')"
        /><label for="on">On</label>
        <input
          type="radio"
          id="min"
          name="axis"
          oninput="glv.sendKey('a')"
        /><label for="min">Minimal</label>
        <input
          type="radio"
          id="gr"
          name="axis"
          oninput="glv.sendKey('a')"
        /><label for="gr">Gray</label>
      </div>

      <p></p>
      <div align="center">
        Mesh:
        <input
          type="radio"
          id="off"
          name="mesh"
          checked="checked"
          oninput="glv.sendKey('m')"
        /><label for="off">Off</label>
        <input
          type="radio"
          id="on"
          name="mesh"
          oninput="glv.sendKey('m')"
        /><label for="on">On</label>
        <input
          type="radio"
          id="ll"
          name="mesh"
          oninput="glv.sendKey('m')"
        /><label for="ll">Level Lines</label>
      </div>
    </div>

    <div id="about-side-nav" class="sidenav">
      <a
        href="javascript:void(0)"
        class="closebtn"
        onclick="closeNav('about-side-nav')"
        >&times;</a
      >
      <a href="https://glvis.org">GLVis</a>
    </div>

    <div class="rotate">
      <span class="side-button" onclick="openNav('setup-side-nav')">Setup</span>
      <span class="side-button" onclick="openNav('help-side-nav', '40ch')"
        >Help</span
      >
      <span onclick="openNav('ctrl-side-nav')">Control</span>
      <span onclick="openNav('about-side-nav')">About</span>
    </div>

    <div align="center">
      <div id="glvis-div" tabindex="0"></div>
    </div>

    <script type="text/javascript">
      // delay control
      // TODO: doesn't work
      /*
      var delay_slider = document.getElementById("delay-range");  
      var delay_value_div = document.getElementById("delay-value");
      function update_delay_value() {
        delay_slider.value = delay_slider.value;
        delay_value_div.innerHTML = `${delay_slider.value} ms`;
      }
      delay_slider.onchange = update_delay_value;
      update_delay_value();
      */

      // nav setup
      function openNav(id, width = "250px") {
        document.getElementById(id).style.width = width;
      }
      function closeNav(id) {
        document.getElementById(id).style.width = "0";
      }

      // websocket setup
      var ws = undefined;
      var que = async.queue(async function (msg) {
        glv.displayStream(msg);
        await new Promise((r) => setTimeout(r, 50));
      });

      function connect() {
        if (ws !== undefined && ws.readyState == 1) {
          ws.close();
          return;
        }

        const host = document.getElementById("host-text").value;
        const port = document.getElementById("port-text").value;
        var btn = document.getElementById("conn-btn");

        const addr = `ws:\/\/${host}:${port}`;
        console.log(`trying to connect to ${addr}`);
        ws = new WebSocket(addr);

        ws.addEventListener("open", function (event) {
          var url = event.target.url;
          console.log(`connected to ${url}`);
          btn.innerHTML = "Disconnect";
        });
        ws.addEventListener("close", function (event) {
          console.log("disconnected");
          btn.innerHTML = "Connect";
        });
        ws.addEventListener("message", function (event) {
          console.log(`got message from ${event.origin}`);
          que.push(event.data);
        });
      }

      // glvis-js setup
      document.getElementById("keys-div").innerHTML = keys_str;
      var div = document.getElementById("glvis-div");
      var glv = new glvis.State(
        div,
        window.innerWidth - 25,
        window.innerHeight - 25
      );
      glv.displayStream(example_stream);
      window.onresize = () => {
        glv.setSize(window.innerWidth - 25, window.innerHeight - 25);
      };
    </script>

    <!--https://tholman.com/github-corners/-->
    <a
      href="https://github.com/glvis/glvis-js"
      class="github-corner"
      aria-label="View source on GitHub"
      ><svg
        width="80"
        height="80"
        viewBox="0 0 250 250"
        style="
          fill: #64ceaa;
          color: #fff;
          position: absolute;
          top: 0;
          border: 0;
          right: 0;
        "
        aria-hidden="true"
      >
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
          d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
          fill="currentColor"
          style="transform-origin: 130px 106px"
          class="octo-arm"
        ></path>
        <path
          d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
          fill="currentColor"
          class="octo-body"
        ></path></svg></a
    ><style>
      .github-corner:hover .octo-arm {
        animation: octocat-wave 560ms ease-in-out;
      }
      @keyframes octocat-wave {
        0%,
        100% {
          transform: rotate(0);
        }
        20%,
        60% {
          transform: rotate(-25deg);
        }
        40%,
        80% {
          transform: rotate(10deg);
        }
      }
      @media (max-width: 500px) {
        .github-corner:hover .octo-arm {
          animation: none;
        }
        .github-corner .octo-arm {
          animation: octocat-wave 560ms ease-in-out;
        }
      }
    </style>
  </body>
</html>
